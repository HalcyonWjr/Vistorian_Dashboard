<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>User Timeline Test</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <link rel="icon" href="img/favicon.png" type="image/png">
  <script src="https://unpkg.com/d3@6.7.0/dist/d3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>
  <script src="https://unpkg.com/textures@1.2.0/dist/textures.js"></script>
</head>

<style>
  .svg {background-color: white;}

  .axis path 
  .axis line { shape-rendering: crispEdges; }
  .axis text { font-weight: bold; font-size: 12px; }

  .eventName {font-size: 12px; font-weight: 300;}
  .sessionName {font-size: 18px;}
</style>

<body>

<!--Header_Section-->
<header>
  <div class="header">
    <img src="img/logo.png" />
    <a href="#general"> > General</a>
    <a href="#vis">> Visualisation</a>
    <a href="#general">> User</a>

    <div class="header-right">
      <h4 style="padding-top:10px ;">last updated: 08/08/2022</h4>
      <!-- <a class="active" href="#upload">Upload</a> -->
    </div>
  </div>
</header>
<!--Header_Section-->



<script>
var dataPath = "https://gist.githubusercontent.com/HalcyonWjr/ce6fc4facd45587af9308f1f129d20ee/raw/8d1a1ba7c887e9ea28481b2460207b87d043afb9/timeline0727.csv"; 
  
var rowConverter = function(d) {
  return {
    usrID: d.usrID,
    session: parseFloat(d.session),
    event: d.event,
    category: d.category,
    view:d.view,
    start: parseFloat(d.start),
    end: parseFloat(d.end)
  }; 
}; 

d3.csv(dataPath, rowConverter)
    .then(function(myData){
        console.log(myData);

    // calculate session length
    var SessionID = "1"; 
    var loopIndex = 0; 
    var endArr = new Array();

    while(loopIndex < myData.length){
      if((myData[loopIndex]).session != SessionID){
        SessionID = myData[loopIndex].session;
        endArr.push({session: myData[loopIndex-1].session, 
          duration:myData[loopIndex-1].end});
      }
      loopIndex++; 
    }

    endArr.push({session: myData[loopIndex-1].session, 
          duration:myData[loopIndex-1].end});
    console.log(endArr); 

    // visualization view array
    var i= 0,
        start = 0,
        viewArr = new Array(),
        viewName = "",
        tmp;
    
    myData[myData.length] = {view: ""};

    var lastViewName = myData[0].view; 
    var currentViewName;

    for(i = 1; i < myData.length; i++){
        if( myData[i].view != lastViewName){
            if(lastViewName == ""){
            // new variable 
                tmp = {
                    session: myData[i].session, 
                    view: myData[i].view, 
                    start: myData[i].start, 
                    end:0
                }; 
            }
            else if(lastViewName == tmp.view){
                tmp.end = myData[i-1].end; 
                viewArr.push(tmp);
            }
        }

        lastViewName = myData[i].view; 
    }
    console.log(viewArr);

    myData.pop();
    
    var w = 1300,
        h = 750,
        yOffset = 50,
        padding = 20; 

    var xScaleDomain = new Array();
    for(let i = 1; i <= d3.max(myData, d => d.session); i++) {
      xScaleDomain.push(i)
    };
    console.log(xScaleDomain);

    var xScale = d3.scaleBand()
                   .domain(xScaleDomain)
                   .range([0, w])
                   .paddingInner(0.82)
                   .paddingOuter(0.45)
                   .align(0.5); 

    var yScale = d3.scaleLinear()
                   .domain([0, d3.max(myData, function (d) {
                     return d.end;
                   })])
                   .range([0, h - 70]); 

    var bgYScale = d3.scaleLinear()
                   .domain([0, d3.max(endArr, function (d) {
                     return d.duration;
                   })])
                   .range([0, h - 70]); 
    
    var viewYScale = d3.scaleLinear()
                     .domain([0, d3.max(viewArr, function (d) {
                        return d.end;
                    })])
                     .range([0, h - 70]); 

    var xAxis = d3.axisTop()
                  .scale(xScale)
                  .ticks(xScaleDomain.length);
    
    var yAxis = d3.axisLeft()
                  .scale(yScale)
                  .ticks(10); 

    var viewYAxis = d3.axisLeft()
                      .scale(viewYScale);

    // Color coding for Event Bars
    var colorScale = d3.scaleOrdinal()
                       .range([ "#ff9900", "#ffe599", "#6aa84f", "#b7b7b7", "#c9daf8"]); 

    // Append the svg element                  
    var svg = d3.select("body")
      .append("svg")
      .attr("class", "svg")
      .attr("width", w)
      .attr("height", h)
      .attr("padding", padding);

    // Background layer: the grey bar of total session length
    svg.selectAll(".bgRect")
      .data(endArr)
      .enter()
      .append("rect")
        .attr("width", xScale.bandwidth())
        .attr("height", d => (bgYScale(d.duration)))
        .attr("x", d => (xScale(d.session)))
        .attr("y", 50)
        .attr("fill", "#F6F6F6");

    svg.selectAll(".sessionNo")
      .data(endArr)
      .enter()
      .append("text")
        .attr("x", d => (xScale(d.session)))
        .attr("y", 30)
        .text(d => "session" + d.session);

    // Event layer: color coded bars of each event
    svg.selectAll(".eventRect")
      .data(myData)
      .enter()
      .append("rect")
        .attr("width", xScale.bandwidth())
        .attr("height", d => (yScale(d.end) - yScale(d.start)))
        .attr("x", d => (xScale(d.session)))
        .attr("y", d => (yScale(d.start)) + 50)
        .attr("fill", d => (colorScale(d.category)));

    svg.selectAll(".eventName")
      .data(myData)
      .enter()
      .append("text")
        .attr("class", "eventName")
        .attr("x", d => (xScale(d.session) + xScale.bandwidth()* 1.1))
        .attr("y", d => ((yScale(d.start) + yScale(d.end)) / 2 + 50))
        .text(d => d.event);

    // Visualization views: add texture scale
    var t1 = textures.lines().size(4).strokeWidth(1);
    var t2 = textures.lines().orientation("3/8", "7/8").strokeWidth(1).stroke("grey").thicker();
    var t3 = textures.paths().d('woven').lighter().thicker();
    
    var texture = [t1, t2, t3];
    
    texture.forEach((t) => {svg.call(t);});

    textureScale = d3.scaleOrdinal()
                     .domain(["node-link", "timeline", "matrix"])
                     .range(texture);

    // Visualization view: append the bars next to session lane
    svg.selectAll(".networkView")
      .data(viewArr)
      .enter()
      .append("rect")
        .attr("width", xScale.bandwidth() / 2)
        .attr("height", d => (yScale(d.end) - yScale(d.start)))
        .attr("x", d => (xScale(d.session)) - xScale.bandwidth() / 2 - 5)
        .attr("y", d => (yScale(d.start) + 50))
        .style("fill", function(d){
            return textureScale(d.view).url();
          });

   // Create swimlanes
   svg.selectAll("line.swimlanes")
      .data(endArr)
      .enter()
      .append("line")
        .attr("x1", d => (xScale(d.session)) + 110)
        .attr("x2", d => (xScale(d.session)) + 110)
        .attr("y1", 50)
        .attr("y2", h - 20)
        .style("stroke", "grey")
        .style("stroke-dasharray", "5,5")
        .style("stroke-width", "1px");
        
    // Adding Y axis
    svg.append("g")
       .attr("class", "axis")
       .attr("transform", "translate(40,50)")
       .call(yAxis);

    })

</script>


</body>
</html>



